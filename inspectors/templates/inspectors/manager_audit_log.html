{% extends "base.html" %} 
{% load i18n %}

{% block content %}
<h2>{{ page_title }}</h2>

<div class="card mb-4 shadow-sm">
    <div class="card-body">
        <form method="GET" class="row g-3 align-items-center">
            
            <div class="col-md-5">
                <label for="searchQuery" class="form-label visually-hidden">بحث</label>
                <input type="text" 
                       class="form-control" 
                       id="searchQuery" 
                       name="q" 
                       placeholder="بحث باسم المستخدم أو السجل المتأثر..."
                       value="{{ search_query|default:'' }}">
            </div>

            <div class="col-md-3">
                <label for="filterAction" class="form-label visually-hidden">تصفية العملية</label>
                <select class="form-select" id="filterAction" name="action">
                    <option value="">-- تصفية حسب العملية --</option>
                    <option value="0" {% if filter_action == '0' %}selected{% endif %}>إنشاء (Create)</option>
                    <option value="1" {% if filter_action == '1' %}selected{% endif %}>تعديل (Update)</option>
                    <option value="2" {% if filter_action == '2' %}selected{% endif %}>حذف (Delete)</option>
                </select>
            </div>

            <div class="col-md-2">
                <label for="filterModel" class="form-label visually-hidden">تصفية النموذج</label>
                <select class="form-select" id="filterModel" name="model">
                    <option value="">-- تصفية حسب النموذج --</option>
                    {% for model in available_models %}
                        <option value="{{ model }}" {% if filter_model == model %}selected{% endif %}>
                            {{ model|capfirst }} 
                        </option>
                    {% endfor %}
                </select>
            </div>

            <div class="col-md-2">
                <button type="submit" class="btn btn-primary w-100">
                    <i class="fas fa-search me-1"></i> بحث
                </button>
            </div>
             <div class="col-md-12 text-center mt-0">
                <a href="{% url 'manager_audit_logs' %}" class="btn btn-outline-secondary btn-sm">
                    <i class="fas fa-redo me-1"></i> إعادة تعيين الفلاتر
                </a>
            </div>
        </form>
    </div>
</div>

<table class="table table-striped">
    <thead>
        <tr>
            <th>{% translate "المستخدم" %}</th>
            <th>{% translate "رقم الهوية" %}</th>
            <th>{% translate "العملية" %}</th>
            <th>{% translate "النموذج" %}</th>
            <th>{% translate "الزمن" %}</th>
            <th>{% translate "السجل المتأثر" %}</th>
            <th>{% translate "التغييرات" %}</th>
        </tr>
    </thead>
    <tbody>
        {% for log in logs %}
        <tr>
            <td>{{ log.actor.username }}</td>

            <td>{{ log.actor.user_id }}
            
            <td><span class="badge bg-{{ log.action|lower }}">{{ log.get_action_display }}</span></td> 
            
            <td>{{ log.content_type.model|capfirst }}</td>
            
            <td>{{ log.timestamp|date:"Y-m-d H:i" }}</td>
            
            <td>{{ log.object_repr }}</td>
            
           {% load audit_filters %}
            <td style="padding: 8px; vertical-align: top;">
                {% for field, change in log.changes.items %}
                    {% with field|prettify_log:"field" as translated_field %}
                    
                    {# حالة الإنشاء (Create) - عرض القيم الغير فارغة فقط #}
                    {% if log.action == 0 %}  {# إنشاء - action 0 #}
                        {% if change.1 %}  {# فقط إذا القيمة الجديدة ليست فارغة #}
                            <div class="change-item">
                                <strong>{{ translated_field }}:</strong>
                                <span class="badge badge-success">[إضافة]</span>
                                <span class="new-value">{{ change.1|prettify_log:"value" }}</span>
                            </div>
                        {% endif %}
                    
                    {# حالة التعديل (Update) - عرض كل القيم حتى الفارغة #}
                    {% elif log.action == 1 %}  {# تعديل - action 1 #}
                        <div class="change-item">
                            <strong>{{ translated_field }}:</strong>
                            <div class="change-comparison">
                                <span class="old-value">
                                    {% if change.0 %}
                                        {{ change.0|prettify_log:"value" }}
                                    {% else %}
                                        <span class="empty-value">[فارغ]</span>
                                    {% endif %}
                                </span>
                                <span class="arrow">→</span>
                                <span class="new-value">
                                    {% if change.1 %}
                                        {{ change.1|prettify_log:"value" }}
                                    {% else %}
                                        <span class="empty-value">[فارغ]</span>
                                    {% endif %}
                                </span>
                            </div>
                        </div>
                    
                    {# حالة الحذف (Delete) - عرض القيم المحذوفة #}
                    {% elif log.action == 2 %}  {# حذف - action 2 #}
                        {% if change.0 %}  {# فقط إذا القيمة القديمة ليست فارغة #}
                            <div class="change-item">
                                <strong>{{ translated_field }}:</strong>
                                <span class="badge badge-danger">[حذف]</span>
                                <span class="old-value">{{ change.0|prettify_log:"value" }}</span>
                            </div>
                        {% endif %}
                    
                    {% endif %}
                    {% endwith %}
                {% empty %}
                    <span class="no-changes">لا توجد تغييرات</span>
                {% endfor %}
            </td>

            <style>
            .change-item {
                margin-bottom: 8px;
                padding: 8px;
                border-bottom: 1px dashed #e0e0e0;
                background: #f8f9fa;
                border-radius: 4px;
            }

            .change-comparison {
                display: flex;
                align-items: center;
                gap: 12px;
                margin-top: 6px;
                flex-wrap: wrap;
            }

            .old-value {
                color: #dc3545;
                text-decoration: line-through;
                padding: 4px 8px;
                background: #fff5f5;
                border-radius: 4px;
                border: 1px solid #f5c6cb;
            }

            .new-value {
                color: #28a745;
                font-weight: bold;
                padding: 4px 8px;
                background: #f0fff4;
                border-radius: 4px;
                border: 1px solid #c3e6cb;
            }

            .empty-value {
                color: #6c757d;
                font-style: italic;
                background: #f8f9fa;
                padding: 2px 6px;
                border-radius: 3px;
            }

            .arrow {
                color: #007bff;
                font-weight: bold;
                font-size: 1.2em;
            }

            .badge {
                padding: 3px 8px;
                border-radius: 4px;
                font-size: 0.85em;
                margin: 0 6px;
                font-weight: bold;
            }

            .badge-success {
                background: #d4edda;
                color: #155724;
                border: 1px solid #c3e6cb;
            }

            .badge-danger {
                background: #f8d7da;
                color: #721c24;
                border: 1px solid #f5c6cb;
            }

            .no-changes {
                color: #6c757d;
                font-style: italic;
                padding: 8px;
                background: #f8f9fa;
                border-radius: 4px;
                display: inline-block;
            }
            </style>
        </tr>
        {% empty %}
        <tr>
            <td colspan="6">{% translate "لا توجد سجلات تدقيق لعرضها." %}</td>
        </tr>
        {% endfor %}
    </tbody>
</table>

{% endblock content %}